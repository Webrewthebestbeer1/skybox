<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skybox Camera</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    margin: 12px 0 8px;
    font-size: 1.3em;
    font-weight: 500;
    color: #ccc;
  }
  .hw-link {
    font-size: 0.75em;
    color: #888;
    text-decoration: none;
    margin-bottom: 10px;
  }
  .hw-link:hover { color: #4fc3f7; }
  .video-container {
    width: 100%;
    max-width: 800px;
    aspect-ratio: 4/3;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    margin: 0 12px;
  }
  .video-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    cursor: pointer;
  }
  .video-container:fullscreen,
  .video-container:-webkit-full-screen {
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .video-container.soft-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    max-width: none;
    border-radius: 0;
    z-index: 9999;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .video-container .no-stream {
    display: none;
    color: #888;
    text-align: center;
    padding-top: 35%;
    font-size: 0.9em;
  }
  .video-container img.error { display: none; }
  .video-container img.error + .no-stream { display: block; }
  .video-container .stream-off {
    display: none;
    color: #888;
    text-align: center;
    padding-top: 35%;
    font-size: 0.9em;
  }
  .video-container.paused img { display: none; }
  .video-container.paused .stream-off { display: block; }
  .stream-toggle {
    padding: 6px 16px;
    font-size: 0.8em;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: #ccc;
    background: #3a3a5c;
    margin-top: 8px;
  }
  .stream-toggle:active { background: #5a5a8c; }

  /* Position bar */
  .pos-bar-wrap {
    width: 100%;
    max-width: 800px;
    margin: 12px 12px 0;
  }
  .pos-bar-labels {
    position: relative;
    display: flex;
    justify-content: space-between;
    font-size: 0.75em;
    color: #888;
    margin-bottom: 2px;
  }
  .pos-bar .lbl-zero {
    position: absolute;
    top: -14px;
    font-size: 0.75em;
    color: #888;
    transform: translateX(-50%);
  }
  .pos-bar {
    width: 100%;
    height: 10px;
    background: #2a2a3e;
    border-radius: 5px;
    position: relative;
  }
  .pos-bar .indicator {
    position: absolute;
    top: 0;
    width: 6px;
    height: 100%;
    background: #4fc3f7;
    border-radius: 3px;
    transition: left 0.15s ease;
    margin-left: -3px;
  }
  .pos-text {
    text-align: center;
    font-size: 0.8em;
    color: #aaa;
    margin-top: 4px;
  }

  /* Controls */
  .controls {
    width: 100%;
    max-width: 800px;
    margin: 16px 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .step-row {
    display: flex;
    gap: 8px;
    justify-content: center;
    position: relative;
  }
  .step-row label {
    position: absolute;
    right: calc(50% + 80px);
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.75em;
    color: #888;
    text-align: right;
    white-space: nowrap;
  }
  .action-row {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 4px;
  }
  button {
    padding: 10px 18px;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    color: #fff;
    background: #3a3a5c;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
    transition: background 0.15s;
  }
  button:active, button.active { background: #5a5a8c; }
  button.left { background: #2e5c8a; }
  button.left:active, button.left.active { background: #4a8ac0; }
  button.right { background: #2e5c8a; }
  button.right:active, button.right.active { background: #4a8ac0; }
  button.stop { background: #8a2e2e; }
  button.stop:active { background: #c04a4a; }
  button.home { background: #2e6e3e; }
  button.home:active { background: #4a9a5a; }

  .status {
    font-size: 0.8em;
    color: #888;
    text-align: center;
    min-height: 1.2em;
  }
  .status.error { color: #e57373; }
  .status.moving { color: #4fc3f7; }

  /* Collapsible panel shared styles */
  .panel-toggle {
    width: 100%;
    background: #2a2a3e;
    color: #aaa;
    border: none;
    border-radius: 6px;
    padding: 10px 16px;
    font-size: 0.85em;
    cursor: pointer;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .panel-toggle:hover { background: #333352; }
  .panel-toggle .arrow { transition: transform 0.2s; }
  .panel-toggle.open .arrow { transform: rotate(180deg); }
  .panel-body { display: none; padding-top: 12px; }
  .panel-body.open { display: block; }

  /* Settings section */
  .settings-section {
    width: 100%;
    max-width: 800px;
    margin: 16px 12px 0;
  }
  .settings-info {
    background: #2a2a3e;
    border-radius: 6px;
    padding: 10px 12px;
    margin-bottom: 10px;
    font-size: 0.8em;
    color: #aaa;
    line-height: 1.6;
  }
  .settings-info .limit-value { color: #4fc3f7; }
  .settings-info .limit-default { color: #888; }
  .settings-row {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }
  .settings-row button { padding: 10px 14px; font-size: 0.9em; }
  button.setting-warn { background: #6e4a2e; }
  button.setting-warn:active { background: #9a6a4a; }

  /* Speed slider */
  .speed-control {
    background: #2a2a3e;
    border-radius: 6px;
    padding: 10px 12px;
    margin-bottom: 10px;
  }
  .speed-control .speed-label {
    font-size: 0.8em;
    color: #aaa;
    margin-bottom: 6px;
    display: flex;
    justify-content: space-between;
  }
  .speed-control .speed-value {
    color: #4fc3f7;
  }
  .speed-control input[type="range"] {
    width: 100%;
    accent-color: #4fc3f7;
  }

  /* Device stats panel */
  .stats-section {
    width: 100%;
    max-width: 800px;
    margin: 12px 12px 0;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  @media (min-width: 600px) {
    .stats-grid { grid-template-columns: 1fr 1fr 1fr; }
  }
  .stat-item {
    background: #2a2a3e;
    border-radius: 6px;
    padding: 10px 12px;
  }
  .stat-item .stat-label {
    font-size: 0.7em;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .stat-item .stat-value {
    font-size: 1em;
    color: #e0e0e0;
  }
  .stat-item .stat-detail {
    font-size: 0.7em;
    color: #666;
    margin-top: 2px;
  }
  .stat-item .stat-value.warn { color: #b8860b; }
  .stat-item .stat-value.crit { color: #e57373; }
  .uptime-bar-wrap {
    margin-top: 12px;
    background: #2a2a3e;
    border-radius: 6px;
    padding: 10px 12px;
  }
  .uptime-bar-wrap .stat-label {
    font-size: 0.7em;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .uptime-bar {
    width: 100%;
    height: 8px;
    background: #8a2e2e;
    border-radius: 4px;
    overflow: hidden;
  }
  .uptime-bar .fill {
    height: 100%;
    background: #2e6e3e;
    border-radius: 4px;
    transition: width 0.3s;
  }
  .uptime-pct-text {
    font-size: 0.8em;
    color: #aaa;
    margin-top: 4px;
  }
  .downtime-list {
    margin-top: 8px;
  }
  .downtime-list .dt-header {
    font-size: 0.7em;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .downtime-list .dt-event {
    font-size: 0.75em;
    color: #aaa;
    padding: 4px 0;
    border-bottom: 1px solid #2a2a3e;
  }
  .downtime-list .dt-none {
    font-size: 0.75em;
    color: #666;
    font-style: italic;
  }

  /* Visitors log */
  .visitors-section {
    width: 100%;
    max-width: 800px;
    margin: 12px 12px 24px;
  }
  .visit-list {
    max-height: 300px;
    overflow-y: auto;
  }
  .visit-entry {
    display: flex;
    justify-content: space-between;
    font-size: 0.8em;
    color: #aaa;
    padding: 5px 0;
    border-bottom: 1px solid #252540;
  }
  .visit-entry .visit-ip { color: #4fc3f7; }
  .visit-entry .visit-time { color: #888; }
  .visit-none {
    font-size: 0.8em;
    color: #666;
    font-style: italic;
  }

  /* Developer settings (hidden until unlocked) */
  .dev-section {
    width: 100%;
    max-width: 800px;
    margin: 12px 12px 24px;
    display: none;
  }
  .dev-section.unlocked { display: block; }
  .dev-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #2a2a3e;
    border-radius: 6px;
    padding: 12px 16px;
  }
  .dev-row .dev-label {
    font-size: 0.9em;
    color: #ccc;
  }
  .toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
  }
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: #3a3a5c;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .toggle-slider::after {
    content: '';
    position: absolute;
    left: 3px;
    top: 3px;
    width: 18px;
    height: 18px;
    background: #aaa;
    border-radius: 50%;
    transition: transform 0.2s, background 0.2s;
  }
  .toggle-switch input:checked + .toggle-slider {
    background: #2e6e3e;
  }
  .toggle-switch input:checked + .toggle-slider::after {
    transform: translateX(20px);
    background: #fff;
  }
  .dev-count-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #2a2a3e;
    border-radius: 6px;
    padding: 12px 16px;
    margin-top: 8px;
  }
  .dev-count-row .dev-label { font-size: 0.9em; color: #ccc; }
  .dev-count-row .count-value {
    font-size: 1.1em;
    color: #4fc3f7;
    font-weight: 500;
    margin: 0 12px;
  }
  .dev-count-row .count-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  button.reset-btn {
    padding: 5px 10px;
    font-size: 0.75em;
    background: #5a3a3a;
    border-radius: 4px;
  }
  button.reset-btn:active { background: #7a4a4a; }

  /* Detection log */
  .detection-log {
    margin-top: 8px;
    background: #2a2a3e;
    border-radius: 6px;
    padding: 12px 16px;
  }
  .detection-log .log-header {
    font-size: 0.8em;
    color: #888;
    margin-bottom: 6px;
  }
  .detection-log .log-list {
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.75em;
    line-height: 1.5;
  }
  .detection-log .log-entry {
    padding: 2px 0;
    border-bottom: 1px solid #252540;
    color: #aaa;
  }
  .detection-log .log-entry.motion { color: #888; }
  .detection-log .log-entry.vehicle_confirmed { color: #4caf50; }
  .detection-log .log-entry.vehicle_cleared { color: #ff9800; }
  .detection-log .log-none {
    font-size: 0.75em;
    color: #666;
    font-style: italic;
  }
</style>
</head>
<body>
  <h1>Skybox Camera</h1>
  <a href="/hardware" class="hw-link">Hardware</a>

  <div class="video-container" id="video-container">
    <img src="/api/stream" alt="Camera stream" id="cam-stream">
    <div class="no-stream">Camera stream unavailable</div>
    <div class="stream-off" id="stream-off">Stream paused</div>
  </div>
  <button class="stream-toggle" id="btn-toggle-stream">Pause Stream</button>

  <div class="pos-bar-wrap">
    <div class="pos-bar-labels">
      <span id="lbl-left"></span>
      <span id="lbl-right"></span>
    </div>
    <div class="pos-bar">
      <div class="indicator" id="pos-indicator"></div>
      <span class="lbl-zero" id="lbl-zero">0</span>
    </div>
    <div class="pos-text">Position: <span id="pos-value">--</span></div>
  </div>

  <div class="controls">
    <div class="step-row">
      <label>Coarse</label>
      <button class="left" data-steps="4000">&laquo; 4k</button>
      <button class="right" data-steps="-4000">4k &raquo;</button>
    </div>
    <div class="step-row">
      <label>Medium</label>
      <button class="left" data-steps="1000">&lsaquo; 1k</button>
      <button class="right" data-steps="-1000">1k &rsaquo;</button>
    </div>
    <div class="step-row">
      <label>Fine</label>
      <button class="left" data-steps="100">&lsaquo; 100</button>
      <button class="right" data-steps="-100">100 &rsaquo;</button>
    </div>
    <div class="action-row">
      <button class="home" id="btn-home">Home</button>
      <button class="stop" id="btn-stop">Stop</button>
    </div>
  </div>

  <div class="status" id="status"></div>

  <div class="settings-section">
    <button class="panel-toggle" id="settings-toggle">
      <span>Settings</span>
      <span class="arrow">&#9660;</span>
    </button>
    <div class="panel-body" id="settings-body">
      <div class="settings-info" id="limits-info">
        Loading limits...
      </div>
      <div class="settings-row">
        <button id="btn-set-left-limit">Set Left Limit</button>
        <button id="btn-set-right-limit">Set Right Limit</button>
      </div>
      <div class="settings-row">
        <button id="btn-set-home">Set Home</button>
        <button class="setting-warn" id="btn-clear-limits">Clear Limits</button>
      </div>
    </div>
  </div>

  <div class="stats-section">
    <button class="panel-toggle" id="stats-toggle">
      <span>Device Stats</span>
      <span class="arrow">&#9660;</span>
    </button>
    <div class="panel-body" id="stats-body">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">Uptime</div>
          <div class="stat-value" id="stat-uptime">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">CPU Temp</div>
          <div class="stat-value" id="stat-cpu-temp">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Memory</div>
          <div class="stat-value" id="stat-memory">--</div>
          <div class="stat-detail" id="stat-memory-detail"></div>
        </div>
        <div class="stat-item">
          <div class="stat-label">CPU Load</div>
          <div class="stat-value" id="stat-cpu-load">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">WiFi Signal</div>
          <div class="stat-value" id="stat-wifi">--</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Disk Usage</div>
          <div class="stat-value" id="stat-disk">--</div>
          <div class="stat-detail" id="stat-disk-detail"></div>
        </div>
      </div>
      <div class="uptime-bar-wrap">
        <div class="stat-label">Availability</div>
        <div class="uptime-bar"><div class="fill" id="uptime-fill"></div></div>
        <div class="uptime-pct-text" id="uptime-pct-text">--</div>
      </div>
      <div class="downtime-list" id="downtime-list">
        <div class="dt-header">Recent Downtime</div>
        <div class="dt-none">No downtime recorded</div>
      </div>
    </div>
  </div>

  <div class="visitors-section">
    <button class="panel-toggle" id="visitors-toggle">
      <span>Visitor Log</span>
      <span class="arrow">&#9660;</span>
    </button>
    <div class="panel-body" id="visitors-body">
      <div class="visit-list" id="visit-list">
        <div class="visit-none">Loading...</div>
      </div>
    </div>
  </div>

  <div class="dev-section" id="dev-section">
    <button class="panel-toggle" id="dev-toggle">
      <span>Developer Settings</span>
      <span class="arrow">&#9660;</span>
    </button>
    <div class="panel-body" id="dev-body">
      <div class="dev-row">
        <span class="dev-label">Count Cars</span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggle-count-cars">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="dev-row" style="margin-top:8px">
        <span class="dev-label">Highlight Cars</span>
        <label class="toggle-switch">
          <input type="checkbox" id="toggle-highlight-cars">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="dev-count-row">
        <span class="dev-label">Cars Counted</span>
        <div class="count-right">
          <span class="count-value" id="car-count-value">0</span>
          <button class="reset-btn" id="btn-reset-car-count">Reset</button>
        </div>
      </div>
      <div class="detection-log" id="detection-log">
        <div class="log-header">Detection Log</div>
        <div class="log-list" id="detection-log-list">
          <div class="log-none">No events yet</div>
        </div>
      </div>
    </div>
  </div>

<script>
console.log('Skybox deployed: ' + new Date().toISOString());
(function() {
  var pollInterval = 5000;
  var pollFast = 500;
  var pollTimer = null;
  var isMoving = false;
  var softLeft = -51200;
  var softRight = 51200;
  var userLimitLeft = null;
  var userLimitRight = null;
  var defaultLimitLeft = -51200;
  var defaultLimitRight = 51200;

  var indicator = document.getElementById('pos-indicator');
  var posValue = document.getElementById('pos-value');
  var lblLeft = document.getElementById('lbl-left');
  var lblRight = document.getElementById('lbl-right');
  var statusEl = document.getElementById('status');

  function setStatus(msg, cls) {
    statusEl.textContent = msg;
    statusEl.className = 'status' + (cls ? ' ' + cls : '');
  }

  function updateBar(pos) {
    var range = softRight - softLeft;
    if (range <= 0) return;
    // Invert bar direction: motor positive is visual left due to flipped video
    var pct = ((softRight - pos) / range) * 100;
    pct = Math.max(0, Math.min(100, pct));
    indicator.style.left = pct + '%';
    posValue.textContent = -pos;
    lblLeft.textContent = -softRight;
    lblRight.textContent = -softLeft;
    // Position the "0" label where motor position 0 falls on the bar
    var zeroPct = (softRight / range) * 100;
    zeroPct = Math.max(0, Math.min(100, zeroPct));
    document.getElementById('lbl-zero').style.left = zeroPct + '%';
  }

  // --- Limits info display ---
  function updateLimitsInfo() {
    var el = document.getElementById('limits-info');
    var hasUserLimits = (userLimitLeft !== null || userLimitRight !== null);

    if (hasUserLimits) {
      // Display inverted values (motor coords are flipped from visual)
      // Visual left = motor right, visual right = motor left
      var leftStr, rightStr;
      if (userLimitRight !== null) {
        leftStr = '<span class="limit-value">' + (-userLimitRight) + '</span>';
      } else {
        leftStr = '<span class="limit-default">' + (-defaultLimitRight) + ' (default)</span>';
      }
      if (userLimitLeft !== null) {
        rightStr = '<span class="limit-value">' + (-userLimitLeft) + '</span>';
      } else {
        rightStr = '<span class="limit-default">' + (-defaultLimitLeft) + ' (default)</span>';
      }
      el.innerHTML = 'Left limit: ' + leftStr + '<br>Right limit: ' + rightStr;
    } else {
      el.innerHTML = 'Using default limits: ' + (-defaultLimitRight) + ' to ' + (-defaultLimitLeft) +
        '<br>Move to a position and set your limits.';
    }
  }

  function fetchStatus() {
    fetch('/api/status')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (d.error) {
          setStatus(d.error, 'error');
          return;
        }
        softLeft = d.soft_limit_left;
        softRight = d.soft_limit_right;
        userLimitLeft = d.user_limit_left;
        userLimitRight = d.user_limit_right;
        defaultLimitLeft = d.default_limit_left;
        defaultLimitRight = d.default_limit_right;
        updateBar(d.position);
        updateLimitsInfo();

        if (d.moving) {
          isMoving = true;
          setStatus('Moving... pos=' + (-d.position) + ' target=' + (-d.target), 'moving');
          schedulePoll(pollFast);
        } else {
          if (isMoving) {
            setStatus('Stopped at ' + (-d.position), '');
          }
          isMoving = false;
          schedulePoll(pollInterval);
        }
      })
      .catch(function(e) {
        setStatus('Connection error', 'error');
        schedulePoll(pollInterval);
      });
  }

  function schedulePoll(ms) {
    if (pollTimer) clearTimeout(pollTimer);
    pollTimer = setTimeout(fetchStatus, ms);
  }

  function postApi(url, body) {
    return fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: body ? JSON.stringify(body) : '{}'
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      if (d.error) setStatus(d.error, 'error');
      schedulePoll(pollFast);
      return d;
    })
    .catch(function(e) {
      setStatus('Connection error', 'error');
    });
  }

  // Step buttons — click and touch-hold
  var stepButtons = document.querySelectorAll('[data-steps]');
  for (var i = 0; i < stepButtons.length; i++) {
    (function(btn) {
      var steps = parseInt(btn.getAttribute('data-steps'), 10);
      var holdTimer = null;
      var holdInterval = null;

      function doStep() {
        postApi('/api/step', {steps: steps});
      }

      function startHold() {
        doStep();
        holdTimer = setTimeout(function() {
          holdInterval = setInterval(doStep, 300);
        }, 500);
        btn.classList.add('active');
      }

      function stopHold() {
        if (holdTimer) { clearTimeout(holdTimer); holdTimer = null; }
        if (holdInterval) { clearInterval(holdInterval); holdInterval = null; }
        btn.classList.remove('active');
      }

      btn.addEventListener('mousedown', function(e) { e.preventDefault(); startHold(); });
      btn.addEventListener('mouseup', stopHold);
      btn.addEventListener('mouseleave', stopHold);
      btn.addEventListener('touchstart', function(e) { e.preventDefault(); startHold(); }, {passive: false});
      btn.addEventListener('touchend', stopHold);
      btn.addEventListener('touchcancel', stopHold);
    })(stepButtons[i]);
  }

  // --- Stop button with hidden dev unlock (3 taps within 2s) ---
  var stopClicks = [];
  document.getElementById('btn-stop').addEventListener('click', function() {
    postApi('/api/stop');
    var now = Date.now();
    stopClicks.push(now);
    // Keep only clicks within last 2 seconds
    stopClicks = stopClicks.filter(function(t) { return now - t < 2000; });
    if (stopClicks.length >= 3) {
      stopClicks = [];
      unlockDevSection();
    }
  });

  document.getElementById('btn-home').addEventListener('click', function() {
    postApi('/api/home');
  });

  // Camera stream error recovery + pause/resume
  var camStream = document.getElementById('cam-stream');
  var videoContainer = document.getElementById('video-container');
  var btnToggleStream = document.getElementById('btn-toggle-stream');
  var streamPaused = false;

  camStream.addEventListener('error', function() {
    if (streamPaused) return;
    camStream.classList.add('error');
    setTimeout(function() {
      if (streamPaused) return;
      camStream.classList.remove('error');
      camStream.src = '/api/stream?' + Date.now();
    }, 5000);
  });

  btnToggleStream.addEventListener('click', function() {
    streamPaused = !streamPaused;
    if (streamPaused) {
      camStream.src = '';
      videoContainer.classList.add('paused');
      btnToggleStream.textContent = 'Resume Stream';
    } else {
      videoContainer.classList.remove('paused');
      camStream.classList.remove('error');
      camStream.src = '/api/stream?' + Date.now();
      btnToggleStream.textContent = 'Pause Stream';
    }
  });

  // Fullscreen on click — native API with CSS fallback for mobile
  var canNativeFullscreen = !!(document.fullscreenEnabled || document.webkitFullscreenEnabled);

  function isFullscreen() {
    return !!(document.fullscreenElement || document.webkitFullscreenElement) ||
           videoContainer.classList.contains('soft-fullscreen');
  }

  function exitSoftFullscreen() {
    videoContainer.classList.remove('soft-fullscreen');
  }

  camStream.addEventListener('click', function() {
    if (document.fullscreenElement || document.webkitFullscreenElement) {
      (document.exitFullscreen || document.webkitExitFullscreen).call(document);
    } else if (videoContainer.classList.contains('soft-fullscreen')) {
      exitSoftFullscreen();
    } else if (canNativeFullscreen) {
      if (videoContainer.requestFullscreen) {
        videoContainer.requestFullscreen();
      } else if (videoContainer.webkitRequestFullscreen) {
        videoContainer.webkitRequestFullscreen();
      }
    } else {
      // Mobile fallback: CSS-based fullscreen
      videoContainer.classList.add('soft-fullscreen');
    }
  });

  // --- Settings panel ---
  var settingsToggle = document.getElementById('settings-toggle');
  var settingsBody = document.getElementById('settings-body');
  var settingsOpen = localStorage.getItem('skybox-settings-open') === '1';

  function applySettingsToggle() {
    if (settingsOpen) {
      settingsToggle.classList.add('open');
      settingsBody.classList.add('open');
    } else {
      settingsToggle.classList.remove('open');
      settingsBody.classList.remove('open');
    }
  }
  applySettingsToggle();

  settingsToggle.addEventListener('click', function() {
    settingsOpen = !settingsOpen;
    localStorage.setItem('skybox-settings-open', settingsOpen ? '1' : '0');
    applySettingsToggle();
  });

  document.getElementById('btn-set-home').addEventListener('click', function() {
    if (confirm('Set current position as home (0)?')) {
      postApi('/api/set-home');
    }
  });

  document.getElementById('btn-set-left-limit').addEventListener('click', function() {
    if (confirm('Set left limit to current position?')) {
      // UI left = motor right (inverted due to flipped video)
      postApi('/api/set-limit-right').then(function(d) {
        if (d && !d.error) {
          userLimitRight = d.user_limit_right;
          softLeft = d.soft_limit_left;
          softRight = d.soft_limit_right;
          updateLimitsInfo();
        }
      });
    }
  });

  document.getElementById('btn-set-right-limit').addEventListener('click', function() {
    if (confirm('Set right limit to current position?')) {
      // UI right = motor left (inverted due to flipped video)
      postApi('/api/set-limit-left').then(function(d) {
        if (d && !d.error) {
          userLimitLeft = d.user_limit_left;
          softLeft = d.soft_limit_left;
          softRight = d.soft_limit_right;
          updateLimitsInfo();
        }
      });
    }
  });

  document.getElementById('btn-clear-limits').addEventListener('click', function() {
    if (confirm('Clear custom limits and revert to defaults?')) {
      postApi('/api/clear-limits').then(function(d) {
        if (d && !d.error) {
          userLimitLeft = d.user_limit_left;
          userLimitRight = d.user_limit_right;
          softLeft = d.soft_limit_left;
          softRight = d.soft_limit_right;
          updateLimitsInfo();
        }
      });
    }
  });

  // --- Device Stats panel ---
  var statsToggle = document.getElementById('stats-toggle');
  var statsBody = document.getElementById('stats-body');
  var statsOpen = localStorage.getItem('skybox-stats-open') === '1';

  function applyStatsToggle() {
    if (statsOpen) {
      statsToggle.classList.add('open');
      statsBody.classList.add('open');
    } else {
      statsToggle.classList.remove('open');
      statsBody.classList.remove('open');
    }
  }
  applyStatsToggle();

  statsToggle.addEventListener('click', function() {
    statsOpen = !statsOpen;
    localStorage.setItem('skybox-stats-open', statsOpen ? '1' : '0');
    applyStatsToggle();
    if (statsOpen) fetchDeviceStats();
  });

  function formatUptime(seconds) {
    if (seconds == null) return 'N/A';
    var d = Math.floor(seconds / 86400);
    var h = Math.floor((seconds % 86400) / 3600);
    var m = Math.floor((seconds % 3600) / 60);
    if (d > 0) return d + 'd ' + h + 'h ' + m + 'm';
    if (h > 0) return h + 'h ' + m + 'm';
    return m + 'm';
  }

  function formatBytes(bytes) {
    if (bytes == null) return 'N/A';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
    return (bytes / 1073741824).toFixed(1) + ' GB';
  }

  function formatTimeAgo(ts) {
    if (ts == null) return '';
    var diff = (Date.now() / 1000) - ts;
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
  }

  function formatDate(ts) {
    if (ts == null) return '';
    var d = new Date(ts * 1000);
    var mon = d.getMonth() + 1;
    var day = d.getDate();
    var h = d.getHours();
    var m = d.getMinutes();
    return mon + '/' + day + ' ' + (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
  }

  function fetchDeviceStats() {
    fetch('/api/device-stats')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        // Uptime
        document.getElementById('stat-uptime').textContent = formatUptime(d.uptime);

        // CPU temp
        var tempEl = document.getElementById('stat-cpu-temp');
        if (d.cpu_temp != null) {
          tempEl.textContent = d.cpu_temp.toFixed(1) + ' \u00B0C';
          tempEl.className = 'stat-value' + (d.cpu_temp >= 80 ? ' crit' : d.cpu_temp >= 65 ? ' warn' : '');
        } else {
          tempEl.textContent = 'N/A';
          tempEl.className = 'stat-value';
        }

        // Memory
        var memEl = document.getElementById('stat-memory');
        var memDetail = document.getElementById('stat-memory-detail');
        if (d.memory) {
          memEl.textContent = d.memory.percent + '%';
          memEl.className = 'stat-value' + (d.memory.percent >= 90 ? ' crit' : d.memory.percent >= 75 ? ' warn' : '');
          memDetail.textContent = formatBytes(d.memory.used) + ' / ' + formatBytes(d.memory.total);
        } else {
          memEl.textContent = 'N/A';
          memEl.className = 'stat-value';
          memDetail.textContent = '';
        }

        // CPU load
        var loadEl = document.getElementById('stat-cpu-load');
        if (d.cpu_load) {
          loadEl.textContent = d.cpu_load.load_1.toFixed(2) + ' / ' + d.cpu_load.load_5.toFixed(2) + ' / ' + d.cpu_load.load_15.toFixed(2);
        } else {
          loadEl.textContent = 'N/A';
        }

        // WiFi
        var wifiEl = document.getElementById('stat-wifi');
        if (d.wifi) {
          wifiEl.textContent = d.wifi.signal_dbm + ' dBm';
        } else {
          wifiEl.textContent = 'N/A';
        }

        // Disk
        var diskEl = document.getElementById('stat-disk');
        var diskDetail = document.getElementById('stat-disk-detail');
        if (d.disk) {
          diskEl.textContent = d.disk.percent + '%';
          diskEl.className = 'stat-value' + (d.disk.percent >= 95 ? ' crit' : d.disk.percent >= 85 ? ' warn' : '');
          diskDetail.textContent = formatBytes(d.disk.used) + ' / ' + formatBytes(d.disk.total);
        } else {
          diskEl.textContent = 'N/A';
          diskEl.className = 'stat-value';
          diskDetail.textContent = '';
        }

        // Downtime / availability
        if (d.downtime) {
          var dt = d.downtime;
          document.getElementById('uptime-fill').style.width = dt.uptime_pct + '%';
          var trackingText = formatUptime(dt.total_tracked_s);
          document.getElementById('uptime-pct-text').textContent = dt.uptime_pct + '% (tracked ' + trackingText + ')';

          var listEl = document.getElementById('downtime-list');
          var html = '<div class="dt-header">Recent Downtime</div>';
          if (dt.recent_events && dt.recent_events.length > 0) {
            for (var i = dt.recent_events.length - 1; i >= 0; i--) {
              var ev = dt.recent_events[i];
              html += '<div class="dt-event">' +
                formatDate(ev.start) + ' — down ' + formatUptime(ev.duration_s) +
                ' (' + formatTimeAgo(ev.end) + ')' +
                '</div>';
            }
          } else {
            html += '<div class="dt-none">No downtime recorded</div>';
          }
          listEl.innerHTML = html;
        }
      })
      .catch(function() {
        // Silently ignore stats fetch errors
      });
  }

  // Poll stats every 10s (independent of motor status polling)
  setInterval(fetchDeviceStats, 10000);

  // --- Visitor Log panel ---
  var visitorsToggle = document.getElementById('visitors-toggle');
  var visitorsBody = document.getElementById('visitors-body');
  var visitorsOpen = localStorage.getItem('skybox-visitors-open') === '1';

  function applyVisitorsToggle() {
    if (visitorsOpen) {
      visitorsToggle.classList.add('open');
      visitorsBody.classList.add('open');
    } else {
      visitorsToggle.classList.remove('open');
      visitorsBody.classList.remove('open');
    }
  }
  applyVisitorsToggle();

  visitorsToggle.addEventListener('click', function() {
    visitorsOpen = !visitorsOpen;
    localStorage.setItem('skybox-visitors-open', visitorsOpen ? '1' : '0');
    applyVisitorsToggle();
    if (visitorsOpen) fetchVisits();
  });

  function fetchVisits() {
    fetch('/api/visits')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        var listEl = document.getElementById('visit-list');
        if (!d.visits || d.visits.length === 0) {
          listEl.innerHTML = '<div class="visit-none">No visits recorded</div>';
          return;
        }
        var html = '';
        for (var i = 0; i < d.visits.length; i++) {
          var v = d.visits[i];
          var ts = new Date(v.timestamp * 1000);
          var mon = ts.getMonth() + 1;
          var day = ts.getDate();
          var hr = ts.getHours();
          var min = ts.getMinutes();
          var timeStr = mon + '/' + day + ' ' +
            (hr < 10 ? '0' : '') + hr + ':' +
            (min < 10 ? '0' : '') + min;
          html += '<div class="visit-entry">' +
            '<span class="visit-ip">' + v.ip + '</span>' +
            '<span class="visit-time">' + timeStr + '</span>' +
            '</div>';
        }
        listEl.innerHTML = html;
      })
      .catch(function() {});
  }

  // Refresh visits every 30s
  setInterval(fetchVisits, 30000);

  // --- Developer Settings panel ---
  var devSection = document.getElementById('dev-section');
  var devToggle = document.getElementById('dev-toggle');
  var devBody = document.getElementById('dev-body');
  var devOpen = localStorage.getItem('skybox-dev-open') === '1';
  var countCarsToggle = document.getElementById('toggle-count-cars');
  var highlightCarsToggle = document.getElementById('toggle-highlight-cars');
  var carCountValue = document.getElementById('car-count-value');

  function unlockDevSection() {
    devSection.classList.add('unlocked');
    fetchDevSettings();
    setTimeout(function() {
      devSection.scrollIntoView({behavior: 'smooth', block: 'start'});
    }, 100);
  }

  function applyDevToggle() {
    if (devOpen) {
      devToggle.classList.add('open');
      devBody.classList.add('open');
    } else {
      devToggle.classList.remove('open');
      devBody.classList.remove('open');
    }
  }
  applyDevToggle();

  devToggle.addEventListener('click', function() {
    devOpen = !devOpen;
    localStorage.setItem('skybox-dev-open', devOpen ? '1' : '0');
    applyDevToggle();
    if (devOpen) fetchDevSettings();
  });

  function fetchDevSettings() {
    fetch('/api/dev-settings')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        countCarsToggle.checked = d.count_cars;
        highlightCarsToggle.checked = d.highlight_cars;
        carCountValue.textContent = d.car_count;
      })
      .catch(function() {});
  }

  countCarsToggle.addEventListener('change', function() {
    postApi('/api/dev-settings', {count_cars: countCarsToggle.checked})
      .then(function(d) {
        if (d) {
          countCarsToggle.checked = d.count_cars;
          carCountValue.textContent = d.car_count;
        }
      });
  });

  highlightCarsToggle.addEventListener('change', function() {
    postApi('/api/dev-settings', {highlight_cars: highlightCarsToggle.checked})
      .then(function(d) {
        if (d) {
          highlightCarsToggle.checked = d.highlight_cars;
          // Reload stream to pick up overlay change
          var camStream = document.getElementById('cam-stream');
          camStream.src = '/api/stream?' + Date.now();
        }
      });
  });

  document.getElementById('btn-reset-car-count').addEventListener('click', function() {
    postApi('/api/dev-settings', {reset_car_count: true})
      .then(function(d) {
        if (d) carCountValue.textContent = d.car_count;
      });
  });

  // Detection log
  var detectionLogList = document.getElementById('detection-log-list');

  function formatLogTime(ts) {
    var d = new Date(ts * 1000);
    var h = d.getHours();
    var m = d.getMinutes();
    var s = d.getSeconds();
    return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
  }

  function formatLogEvent(ev) {
    var t = formatLogTime(ev.time);
    if (ev.event === 'vehicle_confirmed') {
      return t + '  CAR #' + ev.count + ' (streak ' + ev.streak + ')';
    } else if (ev.event === 'vehicle_cleared') {
      return t + '  cleared';
    } else if (ev.event === 'motion') {
      return t + '  motion ' + ev.motion_pct + '% streak=' + ev.streak + ' jitter=' + ev.jitter[0] + ',' + ev.jitter[1];
    }
    return t + '  ' + ev.event;
  }

  function fetchDetectionLog() {
    fetch('/api/detection-log')
      .then(function(r) { return r.json(); })
      .then(function(d) {
        if (!d.events || d.events.length === 0) {
          detectionLogList.innerHTML = '<div class="log-none">No events yet</div>';
          return;
        }
        // Show most recent first, skip consecutive motion events to reduce noise
        var filtered = [];
        for (var i = d.events.length - 1; i >= 0; i--) {
          var ev = d.events[i];
          if (ev.event === 'motion') {
            // Only show motion events right before a confirmation
            if (i + 1 < d.events.length && d.events[i + 1].event === 'vehicle_confirmed') {
              filtered.push(ev);
            }
          } else {
            filtered.push(ev);
          }
        }
        var html = '';
        var limit = Math.min(filtered.length, 30);
        for (var j = 0; j < limit; j++) {
          var e = filtered[j];
          html += '<div class="log-entry ' + e.event + '">' + formatLogEvent(e) + '</div>';
        }
        detectionLogList.innerHTML = html;
      })
      .catch(function() {});
  }

  // Poll dev settings every 5s to update car count when counting
  var devPollTimer = null;
  function scheduleDevPoll() {
    if (devPollTimer) clearTimeout(devPollTimer);
    devPollTimer = setTimeout(function() {
      if (countCarsToggle.checked) {
        fetchDevSettings();
        fetchDetectionLog();
      }
      scheduleDevPoll();
    }, 5000);
  }

  // Keyboard arrow keys: left/right for 1k steps
  document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      postApi('/api/step', {steps: 1000});
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      postApi('/api/step', {steps: -1000});
    }
  });

  // Initial poll
  fetchStatus();
  fetchDeviceStats();
  fetchVisits();
  scheduleDevPoll();
})();
</script>
</body>
</html>
